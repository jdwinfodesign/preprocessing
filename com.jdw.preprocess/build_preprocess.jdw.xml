<?xml version="1.0" encoding="UTF-8"?>
<!--
  This file is part of the DITA Open Toolkit project.
  See the accompanying license.txt file for applicable licenses.
-->
<project name="jdw.preprocess.jdw">

  <target name="dita2preprocess.jdw" 
          depends="build-init, 
          preprocess2.preprocess.jdw">
  </target>

  <!-- jdw 09-16-2023 moved to topics target below add-identifiers -->
  <target name="preprocess2.preprocess.jdw" description="Preprocess" 
         depends="preprocess2.init,
                  ditaval-merge,
                  
                  preprocess2.maps,
                  preprocess2.topics.preprocess.jdw">
    <!-- 
    , 
    add-identifiers
    -->
    <dirname property="_dita.map.output.dir" file="${dita.output.dir}/${user.input.file}"/>
    <dirname property="_dita.map.temp.dir" file="${dita.temp.dir}/${user.input.file}"/>
    <property name="uplevels" value=""/>
    <property name="dita.map.output.dir" location="${_dita.map.output.dir}/${uplevels}"/>
  </target>

  <!-- Here is where the topics get numbered,       -->
  <!-- ⇊  right after topic-chunk.            ⇊    -->
  <!-- Add a target to count the figs in a topic    -->
  <!-- removing number-topics from depends for test -->
  <!-- ⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊⇊ -->

  <target name="preprocess2.topics.preprocess.jdw" depends="read-job">
    <fileset id="dist.contents" dir="${dita.temp.dir}" includes="*"/> 
    <property name="prop.dist.contents" refid="dist.contents"/>
    
    <echo message="args.input: ${args.input}"/>
    <echo message="dita.temp.dir: ${dita.temp.dir}"/>
    <echo>temp dir: ${prop.dist.contents}</echo>
  </target>
  
  <!-- where to add @id's for figs? 
       Can be added just before number-topics, but 
       all those @id's sure do clutter up the temp files
  -->
  <!-- this is a handy spare parts bin for now 
  <target name="preprocess2.topics.preprocess.jdw" 
    depends="topic-reader,
    topic-branch-filter,
    topic-keyref,
    topic-copy-to,
    topic-conrefpush,
    topic-conref,
    topic-profile,
    preprocess2.topic-fragment,
    topic-chunk,
    
    add-identifiers,
    number-topics,
    list-figs,
    number-figs, 
    
    add-fig-nums
    
    topic-move-meta-entries,
    add-numbers-to-titles,
    topic-maplink,
    topic-topicpull"/>
   ======================================= -->
  <!-- ============================================================= -->
  <!-- .job file -->
  <target name="read-job">
    <pipeline message="Get stuff out of job file" taskname="read job file">
      <xslt basedir="${dita.temp.dir}"
        style="${dita.plugin.com.jdw.preprocess.jdw.dir}/xsl/read-job.xsl"
        in="${dita.temp.dir}/.job.xml"
        out="${dita.temp.dir}/jobCopy.xml">
        <param name="args.input" expression="${args.input}"/>
      </xslt>
    </pipeline>
  </target>
  <!-- ============================================================= -->
  <!-- Add ID attribute to all block level elements -->
  <target name="add-identifiers">
    <pipeline message="Add IDs to blocks" taskname="add-identifiers">
      <xslt basedir="${dita.temp.dir}"
        style="${dita.plugin.com.jdw.preprocess.jdw.dir}/xsl/add-identifiers.xsl">
        <ditaFileset format="dita"/>
        <xmlcatalog refid="dita.catalog"/>
      </xslt>
    </pipeline>
  </target>

  <!-- Add a topic number to all topics that go in the TOC. -->
  <target name="number-topics">
    <echo message="plugin: ${dita.plugin.com.jdw.preprocess.jdw.dir}"/>
    <pipeline message="Add numbers to topicrefs" taskname="number-topics">
      <xslt basedir="${dita.temp.dir}"
        style="${dita.plugin.com.jdw.preprocess.jdw.dir}/xsl/add-topic-numbers.xsl">
        <ditaFileset format="ditamap" input="true"/>
        <xmlcatalog refid="dita.catalog"/>
      </xslt>
    </pipeline>
  </target>
  
  <!-- topics are numbered, figs should be listed (for now in an external process -->
  <!-- this is where we will need to merge the numbered figs back into the topics -->
  <!-- they were pulled from -->
  <!-- it is too early in the process to sweep the metadata into the topics -->
  <!-- so try duplicating the number-topics target above -->
  <!-- I just noticed the answer to a question I have had about how prefixing titles worked -->
  <!-- there are templates in there for maps and topics alike -->
  <!-- made possible by the two ditaFilesets below, one for maps, one for topics -->
  <!-- first, list figs by chapter -->
  
  <target name="list-figs">
    <property name="mainMapFile" value="${dita.temp.dir}/bf4849513c0985714747004f9c2a196558a8ff9f.ditamap"/>
    <echo message="dita.temp.dir: ${dita.temp.dir}"/>
    <echo message="mainMapFile: ${mainMapFile}"/>
    <!-- 
    /job/property[1]/@name
    -->
    <property name="jobFile" value="${dita.temp.dir}/.job.xml"></property>
    <echo message="jobFile: ${jobFile}"/>
    <pipeline message="Listing figs" taskname="number-figs">
      
      <xslt basedir="${dita.temp.dir}"
        style="${dita.plugin.com.jdw.preprocess.jdw.dir}/xsl/list-figs.xsl"
        in="${mainMapFile}"
        out="${dita.temp.dir}/list.xml">
      </xslt>
    </pipeline>
  </target>
  
  <!-- ============================================================================ -->
  <target name="number-figs">
    <echo message="Numbering figures"/>
    <echo message="$args.input: ${args.input}"/>
    <pipeline message="Numbering figs" taskname="number-figs">
      <xslt basedir="${dita.temp.dir}"
        style="${dita.plugin.com.jdw.preprocess.jdw.dir}/xsl/num-figs.xsl"
        in="${dita.temp.dir}/list.xml"
        out="${dita.temp.dir}/num-figs.xml">
<!--        <ditaFileset format="ditamap" input="true"/>-->
<!--        <ditaFileset format="dita" processingRole="normal"/>-->
      </xslt>
    </pipeline>
  </target>
  
  <!-- Add fig numbers. -->
  <target name="add-fig-nums">
    <echo message="target: add-fig-nums"/>
    <pipeline message="Add numbers to topicrefs" taskname="number-topics">
      <xslt basedir="${dita.temp.dir}"
        style="${dita.plugin.com.jdw.preprocess.jdw.dir}/xsl/add-fig-numbers.xsl">
        <ditaFileset format="ditamap" input="true"/>
        <xmlcatalog refid="dita.catalog"/>
      </xslt>
    </pipeline>
  </target>
  
  <!-- =========================================================================== -->
  <!-- Move generated topic numbers into the title. -->
  <target name="add-numbers-to-titles">
    <pipeline message="Add numbers to topicrefs" taskname="number-topics">
      <xslt basedir="${dita.temp.dir}"
        style="${dita.plugin.com.jdw.preprocess.jdw.dir}/xsl/prefix-titles-with-numbers.xsl">
        <ditaFileset format="ditamap" input="true"/>
        <ditaFileset format="dita" processingRole="normal"/>
        <xmlcatalog refid="dita.catalog"/>
      </xslt>
    </pipeline>
  </target>

</project>
